name: Auto-Analyze on New Scraped Articles

on:
  push:
    paths:
      - 'reports/scraped/scraped_*.json'
    branches:
      - master
      - main

permissions:
  contents: write

jobs:
  analyze:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Potrzebne do porÃ³wnania z poprzednim commitem
      
      - name: Detect new scraped files
        id: detect
        run: |
          # ZnajdÅº nowe pliki scraped w ostatnim commicie
          NEW_FILES=$(git diff --name-only HEAD~1 HEAD -- reports/scraped/scraped_*.json | wc -l)
          echo "new_count=${NEW_FILES}" >> $GITHUB_OUTPUT
          
          if [ "${NEW_FILES}" -eq 0 ]; then
            echo "No new scraped files detected"
            exit 0
          fi
          
          echo "Found ${NEW_FILES} new scraped articles"
      
      - name: Set up Python
        if: steps.detect.outputs.new_count > 0
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        if: steps.detect.outputs.new_count > 0
        run: |
          python -m pip install --upgrade pip
          pip install openai pyyaml
      
      - name: Analyze new articles
        if: steps.detect.outputs.new_count > 0
        env:
          GITHUB_TOKEN: ${{ secrets.CLICKBAIT_VERIFIER_SECRET }}
        run: |
          # Analizuj tylko nowe (niezanalizowane)
          python scripts/analyze_with_github_models.py --limit ${{ steps.detect.outputs.new_count }} --delay 5
      
      - name: Commit analysis results
        if: steps.detect.outputs.new_count > 0
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add reports/analysis/*.json
          
          if git diff --cached --quiet; then
            echo "No new analyses (already existed)"
            exit 0
          fi
          
          git commit -m "ðŸ¤– Auto-analyze: ${{ steps.detect.outputs.new_count }} new articles"
          git push
      
      - name: Summary
        if: always() && steps.detect.outputs.new_count > 0
        run: |
          echo "## Auto-Analysis Triggered" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Analyzed **${{ steps.detect.outputs.new_count }}** new scraped articles" >> $GITHUB_STEP_SUMMARY
